---
import { Image } from 'astro:assets';
import ExifReader from 'exifreader';
import fs from 'node:fs';
import path from 'node:path';

const GOOGLE_MAPS_API_KEY = import.meta.env.GOOGLE_MAPS_API_KEY;

const galleryDir = path.join(process.cwd(), 'part-of-my-brain/gallery');
const files = fs.readdirSync(galleryDir).filter(f => /\.(jpg|jpeg|png|webp)$/i.test(f));

// Dynamically import all gallery images
const imageModules = import.meta.glob<{ default: ImageMetadata }>(
  '/part-of-my-brain/gallery/*.{jpg,jpeg,png,webp}',
  { eager: true }
);

interface ImageData {
  src: ImageMetadata;
  filename: string;
  date: string | null;
  location: string | null;
}

const images: ImageData[] = await Promise.all(
  files.map(async (filename) => {
    const filePath = path.join(galleryDir, filename);
    const buffer = fs.readFileSync(filePath);

    let date: string | null = null;
    let location: string | null = null;

    try {
      const tags = ExifReader.load(buffer);

      // Get date
      if (tags['DateTimeOriginal']) {
        const rawDate = tags['DateTimeOriginal'].description;
        // Format: "2024:01:15 14:30:00" -> "Jan 15, 2024"
        const [datePart] = rawDate.split(' ');
        const [year, month, day] = datePart.split(':');
        const dateObj = new Date(parseInt(year), parseInt(month) - 1, parseInt(day));
        date = dateObj.toLocaleDateString('en-US', {
          year: 'numeric',
          month: 'short',
          day: 'numeric'
        });
      }

      // Get GPS location
      if (tags['GPSLatitude'] && tags['GPSLongitude']) {
        const lat = parseFloat(tags['GPSLatitude'].description).toFixed(6);
        const lng = parseFloat(tags['GPSLongitude'].description).toFixed(6);
        location = `${lat}, ${lng}`;
      }
    } catch (e) {
      // EXIF parsing failed, continue without metadata
    }

    // Get the imported image module
    const modulePath = `/part-of-my-brain/gallery/${filename}`;
    const imageModule = imageModules[modulePath];

    return {
      src: imageModule?.default,
      filename,
      date,
      location,
    };
  })
);

// Sort by date (newest first), images without dates go last
images.sort((a, b) => {
  if (!a.date && !b.date) return 0;
  if (!a.date) return 1;
  if (!b.date) return -1;
  return new Date(b.date).getTime() - new Date(a.date).getTime();
});
---

<div class="gallery">
  {images.filter(img => img.src).map((image, index) => (
    <figure class="gallery-item">
      <Image src={image.src} alt={image.filename} loading={index < 2 ? "eager" : "lazy"} />
      {(image.date || image.location) && (
        <figcaption>
          {image.date}{image.date && image.location && ' Â· '}
          {image.location && (
            <span class="geo-coords" data-location={image.location}>
              {image.location}
              <div class="map-tooltip">
                <iframe
src={`https://www.google.com/maps/embed/v1/place?key=${GOOGLE_MAPS_API_KEY}&q=${image.location.replace(' ', '')}&zoom=15`}
                  width="280"
                  height="200"
                  style="border:0;"
                  loading="lazy"
                  referrerpolicy="no-referrer-when-downgrade"
                  allowfullscreen
                ></iframe>
              </div>
            </span>
          )}
        </figcaption>
      )}
    </figure>
  ))}
</div>

<style>
  .gallery {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
    gap: 1.5rem;
  }

  .gallery-item {
    margin: 0;
  }

  .gallery-item img {
    width: 100%;
    height: auto;
  }

  figcaption {
    margin-top: 0.5rem;
    font-size: 0.75rem;
    font-family: monospace;
    color: #666;
  }

  .geo-coords {
    position: relative;
    cursor: pointer;
    text-decoration: underline;
    text-decoration-style: dotted;
    text-underline-offset: 2px;
  }

  .map-tooltip {
    position: absolute;
    bottom: 100%;
    left: 50%;
    transform: translateX(-50%);
    margin-bottom: 8px;
    padding: 4px;
    background: white;
    border-radius: 8px;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
    opacity: 0;
    visibility: hidden;
    transition: opacity 0.2s, visibility 0.2s;
    z-index: 100;
    pointer-events: none;
  }

  .geo-coords:hover .map-tooltip {
    opacity: 1;
    visibility: visible;
    pointer-events: auto;
  }

  .map-tooltip iframe {
    display: block;
    border-radius: 4px;
  }
</style>
